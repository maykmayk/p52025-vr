<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Video 360 VR</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <style>
    body {
      margin: 0;
      background: #000;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      color: #fff;
    }

    /* Bottone grosso per Quest */
    #enter-vr-btn {
      position: fixed;
      z-index: 9999;
      left: 50%;
      bottom: 24px;
      transform: translateX(-50%);
      padding: 12px 20px;
      border-radius: 999px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      background: #ffffff;
      color: #000000;
      cursor: pointer;
    }

    #enter-vr-btn:active {
      transform: translateX(-50%) scale(0.97);
    }

    /* Bottone carica video */
    #load-video-btn {
      position: fixed;
      z-index: 9999;
      left: 50%;
      bottom: 70px;
      transform: translateX(-50%);
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      font-weight: 500;
      background: #333333;
      color: #ffffff;
      cursor: pointer;
    }

    #load-video-btn:active {
      transform: translateX(-50%) scale(0.97);
    }

    /* VR UI styles */
    .vr-ui {
      pointer-events: all;
    }
  </style>
</head>

<body>
  <!-- Bottone per caricare un video locale -->
  <button id="load-video-btn">Carica video</button>
  <!-- Input file nascosto -->
  <input id="video-file-input" type="file" accept="video/*" style="display:none" />

  <!-- Video 360 (di default prova a usare video.mp4, ma viene sovrascritto se l'utente carica un file) -->
  <video
    id="video360"
    src="video.mp4"
    playsinline
    webkit-playsinline
    crossorigin="anonymous"
    preload="auto">
  </video>

  <!-- Bottone manuale per entrare in VR -->
  <button id="enter-vr-btn">Entra in VR</button>

  <!-- Scena VR -->
  <a-scene vr-mode-ui="enabled: true" xr-mode-ui="enabled: true" embedded="false">
    <a-assets>
      <!-- Preload assets -->
      <img id="play-icon" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M8 5v14l11-7z'/%3E%3C/svg%3E">
      <img id="pause-icon" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M6 4h4v16H6V4zm8 0h4v16h-4V4z'/%3E%3C/svg%3E">
      <img id="restart-icon" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z'/%3E%3C/svg%3E">
    </a-assets>

    <!-- La rotazione la gestiamo via JS -->
    <a-videosphere id="sphere" src="#video360" rotation="0 0 0"></a-videosphere>

    <!-- Camera with cursor and controllers -->
    <a-camera>
      <!-- VR UI Container (fixed to camera) -->
      <a-entity id="vr-ui-container" position="0 -0.3 -1.5" visible="false">
        <!-- Background panel -->
        <a-plane
          id="ui-background"
          width="0.7"
          height="0.25"
          color="#000000"
          opacity="0.7"
          position="0 0 0">
        </a-plane>

        <!-- Play/Pause Button (sinistra) -->
        <a-plane
          id="play-pause-btn"
          class="vr-ui clickable"
          width="0.25"
          height="0.25"
          position="-0.18 0 0.01"
          src="#play-icon"
          material="transparent: true"
          animation__click="property: scale; from: 1 1 1; to: 0.9 0.9 0.9; dur: 100; startEvents: click"
          animation__clickback="property: scale; from: 0.9 0.9 0.9; to: 1 1 1; dur: 100; startEvents: animationcomplete__click">
        </a-plane>

        <!-- Restart Button (destra) -->
        <a-plane
          id="restart-btn"
          class="vr-ui clickable"
          width="0.25"
          height="0.25"
          position="0.18 0 0.01"
          src="#restart-icon"
          material="transparent: true"
          visible="true"
          animation__click="property: scale; from: 1 1 1; to: 0.9 0.9 0.9; dur: 100; startEvents: click"
          animation__clickback="property: scale; from: 0.9 0.9 0.9; to: 1 1 1; dur: 100; startEvents: animationcomplete__click">
        </a-plane>
      </a-entity>

      <!-- Cursor for raycaster interaction -->
      <a-entity
        cursor="fuse: false; fuseTimeout: 0"
        raycaster="objects: .clickable; far: 10"
        position="0 0 -0.1">
      </a-entity>
    </a-camera>

    <!-- Hand controllers -->
    <a-entity
      id="left-hand"
      laser-controls="hand: left"
      raycaster="objects: .clickable; far: 10; showLine: true; lineColor: white; lineOpacity: 0.8">
    </a-entity>

    <a-entity
      id="right-hand"
      laser-controls="hand: right"
      raycaster="objects: .clickable; far: 10; showLine: true; lineColor: white; lineOpacity: 0.8">
    </a-entity>
  </a-scene>

  <script>
    // ===== PARAMETRO "NORD" DEL VIDEO =====
    // Questo è l'angolo del video che vuoi davanti quando entri in VR.
    // Cambia questo numero finché non ti piace:
    //   0   = fronte
    //   90  = ruotato a destra
    //   -90 = ruotato a sinistra
    //   180 = dietro
    const INITIAL_YAW = 0;

    // ===== CORE ELEMENTS =====
    const video = document.getElementById("video360");
    const scene = document.querySelector("a-scene");
    const enterVrBtn = document.getElementById("enter-vr-btn");
    const loadVideoBtn = document.getElementById("load-video-btn");
    const videoFileInput = document.getElementById("video-file-input");

    let isInVR = false;
    let uiContainer = null;
    let playPauseBtn = null;
    let restartBtn = null;
    let uiHideTimeout = null;
    let lastControllerMove = 0;
    let sphere = null;
    let cameraEl = null;

    // ===== CARICAMENTO VIDEO LOCALE =====
    loadVideoBtn.addEventListener("click", () => {
      videoFileInput.click();
    });

    videoFileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const blobUrl = URL.createObjectURL(file);
      video.src = blobUrl;
      video.currentTime = 0;
      video.load();
      video.play().catch(() => {});

      updateUI();
    });

    // ===== INITIAL UNLOCK =====
    const unlock = () => {
      document.removeEventListener("click", unlock);
    };
    document.addEventListener("click", unlock);

    // ===== SCENE LOADED =====
    scene.addEventListener("loaded", () => {
      uiContainer = document.getElementById("vr-ui-container");
      playPauseBtn = document.getElementById("play-pause-btn");
      restartBtn = document.getElementById("restart-btn");
      sphere = document.getElementById("sphere");
      cameraEl = document.querySelector("a-camera");

      // Rotazione di base per modalità NON VR (browser normale)
      if (sphere) {
        sphere.setAttribute("rotation", `0 ${INITIAL_YAW} 0`);
      }

      setupButtonHandlers();
      setupControllerMovement();
    });

    // ===== BUTTON HANDLERS =====
    function setupButtonHandlers() {
      playPauseBtn.addEventListener("click", () => {
        if (video.paused) {
          video.play().catch(() => { });
        } else {
          video.pause();
        }
        updateUI();
      });

      restartBtn.addEventListener("click", () => {
        video.currentTime = 0;
        video.play().catch(() => { });
        updateUI();
      });
    }

    // ===== CONTROLLER MOVEMENT DETECTION =====
    function setupControllerMovement() {
      const leftHand = document.getElementById("left-hand");
      const rightHand = document.getElementById("right-hand");

      let lastLeftPos = null;
      let lastRightPos = null;

      scene.addEventListener("render-target-loaded", () => {
        setInterval(() => {
          if (!isInVR) return;

          let moved = false;

          if (leftHand && leftHand.object3D) {
            const leftPos = leftHand.object3D.position;
            if (lastLeftPos) {
              const distance = lastLeftPos.distanceTo(leftPos);
              if (distance > 0.01) moved = true;
            }
            lastLeftPos = leftPos.clone();
          }

          if (rightHand && rightHand.object3D) {
            const rightPos = rightHand.object3D.position;
            if (lastRightPos) {
              const distance = lastRightPos.distanceTo(rightPos);
              if (distance > 0.01) moved = true;
            }
            lastRightPos = rightPos.clone();
          }

          if (moved) {
            onControllerMove();
          }
        }, 50);
      });

      leftHand?.addEventListener("raycaster-intersection", onControllerMove);
      rightHand?.addEventListener("raycaster-intersection", onControllerMove);
    }

    // ===== CONTROLLER MOVE HANDLER =====
    function onControllerMove() {
      lastControllerMove = Date.now();
      showUI();

      clearTimeout(uiHideTimeout);
      uiHideTimeout = setTimeout(() => {
        if (Date.now() - lastControllerMove >= 3000) {
          hideUI();
        }
      }, 3000);
    }

    // ===== UI VISIBILITY =====
    function showUI() {
      if (uiContainer && isInVR) {
        uiContainer.setAttribute("visible", true);
        updateUI();
      }
    }

    function hideUI() {
      if (uiContainer && isInVR) {
        uiContainer.setAttribute("visible", false);
      }
    }

    // ===== UPDATE UI BASED ON VIDEO STATE =====
    function updateUI() {
      if (!playPauseBtn || !restartBtn) return;

      playPauseBtn.setAttribute("visible", true);
      restartBtn.setAttribute("visible", true);

      if (video.paused) {
        playPauseBtn.setAttribute("src", "#play-icon");
      } else {
        playPauseBtn.setAttribute("src", "#pause-icon");
      }
    }

    // ===== VIDEO EVENTS =====
    video.addEventListener("play", updateUI);
    video.addEventListener("pause", updateUI);
    video.addEventListener("ended", () => {
      video.pause();
      updateUI();
      showUI();
    });

    video.addEventListener("timeupdate", () => {
      if (video.currentTime < 0.5 && !video.paused) {
        updateUI();
      }
    });

    // ===== VR MODE EVENTS =====
    scene.addEventListener("enter-vr", () => {
      isInVR = true;

      // Qui sistemiamo l'orientamento "a prescindere" da come sei girato
      if (sphere && cameraEl && cameraEl.object3D && window.THREE && THREE.MathUtils) {
        const yawRad = cameraEl.object3D.rotation.y;           // rotazione testa in radianti
        const yawDeg = THREE.MathUtils.radToDeg(yawRad);       // in gradi
        const correctedYaw = INITIAL_YAW - yawDeg;             // ruotiamo la sfera al contrario
        sphere.setAttribute("rotation", `0 ${correctedYaw} 0`);
      }

      if (video.src) {
        video.currentTime = 0;
        video.play().catch(() => { });
      }

      setTimeout(() => {
        showUI();
        onControllerMove();
      }, 500);
    });

    scene.addEventListener("exit-vr", () => {
      isInVR = false;
      video.pause();
      hideUI();
      clearTimeout(uiHideTimeout);
    });

    // ===== ENTER VR BUTTON =====
    enterVrBtn.addEventListener("click", () => {
      scene.enterVR();
    });

    // ===== VISIBILITY CHANGE (HEADSET ON/OFF) =====
    document.addEventListener("visibilitychange", () => {
      if (!document.hidden && isInVR) {
        if (video.paused || video.ended) {
          video.currentTime = 0;
          video.play().catch(() => { });
        }
      } else if (isInVR) {
        video.pause();
      }
    });
  </script>
</body>
</html>